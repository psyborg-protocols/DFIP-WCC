<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horse Weight Carrying Capacity Calculator</title>
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- KaTeX (lightweight math typesetting) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Tailwind config: modern, accessible palette
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: {
              50:  "#f6f8fa", 100: "#eef2f7", 200: "#e1e8ef", 300: "#cbd6e2",
              400: "#9fb3c8", 500: "#6b8eb1", 600: "#4b6f94", 700: "#395976",
              800: "#2e475e", 900: "#263a4d"
            },
            accent: {
              50:  "#f0fdf6", 100: "#dcfce7", 200: "#bbf7d0", 300: "#86efac",
              400: "#4ade80", 500: "#22c55e", 600: "#16a34a", 700: "#15803d",
              800: "#166534", 900: "#14532d"
            },
            warn: { 100: "#fff7ed", 400: "#fb923c", 600: "#ea580c" }
          },
          boxShadow: {
            soft: "0 10px 30px rgba(20, 35, 55, 0.15)",
            highlight: "0 0 0 4px rgba(34, 197, 94, 0.6)"
          },
          fontFamily: {
            ui: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji'],
            mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace']
          },
          transitionProperty: { 'position': 'top, left, right, bottom' },
        }
      }
    }
  </script>
  <style>
    body::before{ content:""; position:fixed; inset:0; background-image:url('https://images.unsplash.com/photo-1598813137992-bb0c10817604?q=80&w=2070&auto=format&fit=crop'); background-size:cover; background-position:center; filter:brightness(0.9) saturate(1.05); z-index:-2; }
    body::after{ content:""; position:fixed; inset:0; background:radial-gradient(ellipse at center, rgba(10,20,30,.0) 0%, rgba(10,20,30,.25) 60%, rgba(10,20,30,.55) 100%); z-index:-1; }
    .popover { position: absolute; transform: translateY(8px); min-width: 260px; z-index: 50; }
    .hidden-vis { visibility: hidden; opacity: 0; transition: visibility 0s linear .1s, opacity .1s ease-in-out; }
    .shown-vis { visibility: visible; opacity: 1; transition-delay: 0s; }
    .tour-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 9998; }
    .stable-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    #tourCard { z-index: 9999; }
    .tour-highlight { position: relative; z-index: 9999; box-shadow: var(--tw-shadow-highlight); border-radius: 0.75rem; transition: box-shadow .3s ease-in-out; }
    /* Styles for stable modal */
    #stableModal { z-index: 9999; transition: opacity .2s ease-in-out, visibility .2s; }
    #stableModal.is-hidden { opacity: 0; visibility: hidden; }
    #stableModal .modal-card { transition: transform .25s ease-out; transform: scale(0.95); }
    #stableModal:not(.is-hidden) .modal-card { transform: scale(1); }
  </style>
</head>
<body class="min-h-screen font-ui text-base-900 bg-base-50">
  <header class="max-w-3xl mx-auto px-4 pt-8 pb-2 md:pt-10">
    <div class="flex items-center gap-3">
      <div class="p-2 rounded-xl bg-accent-100 ring-1 ring-accent-300/60">
        <svg aria-hidden="true" viewBox="0 0 24 24" class="w-6 h-6 text-accent-700"><path fill="currentColor" d="M3 18c0-2 2-4 4-4h2l3-6 2 4h3a4 4 0 0 1 4 4v2H3v-2Z"/></svg>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-white drop-shadow">Horse Weight Carrying Capacity</h1>
        <p class="text-base-200 text-sm">Modern, field-friendly calculator with tracking</p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 pb-20">
    <section class="bg-white/90 backdrop-blur rounded-2xl shadow-soft ring-1 ring-base-300 overflow-hidden">
      <!-- Top bar -->
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center justify-between p-4 md:p-5 bg-base-50/70 border-b border-base-200">
        <div class="flex items-center gap-3">
          <h2 class="text-base md:text-lg font-semibold text-base-800">Calculator</h2>
          <div id="activeHorseIndicator" class="hidden items-center gap-1.5 text-xs font-medium text-accent-700 bg-accent-100 px-2 py-0.5 rounded-md">
            <svg viewBox="0 0 24 24" class="w-3 h-3"><path fill="currentColor" d="M3 18c0-2 2-4 4-4h2l3-6 2 4h3a4 4 0 0 1 4 4v2H3v-2Z"/></svg>
            <span id="activeHorseName"></span>
          </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="openStableBtn" class="inline-flex flex-1 sm:flex-initial items-center justify-center gap-2 text-accent-700 hover:text-accent-800 text-sm font-medium px-2.5 py-1.5 rounded-md bg-accent-100 hover:bg-accent-200 ring-1 ring-accent-200 transition">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M19.5 2h-15A2.5 2.5 0 0 0 2 4.5v15A2.5 2.5 0 0 0 4.5 22h15a2.5 2.5 0 0 0 2.5-2.5v-15A2.5 2.5 0 0 0 19.5 2Zm-8.41 15.54a1.5 1.5 0 0 1-1.63-1.25l-.79-3.56-2.22-2.22a1.5 1.5 0 0 1 .45-2.52l10-3.33a1.5 1.5 0 0 1 1.93 1.93l-3.33 10a1.5 1.5 0 0 1-2.52.45l-2.22-2.22-3.56-.79a1.5 1.5 0 0 1-1.25-1.63Z"/></svg>
              My Stable
            </button>
            <button id="tourStart" class="inline-flex flex-1 sm:flex-initial items-center justify-center gap-2 text-accent-700 hover:text-accent-800 text-sm font-medium px-2.5 py-1.5 rounded-md bg-accent-100 hover:bg-accent-200 ring-1 ring-accent-200 transition">
              <svg aria-hidden="true" viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 15h-2v-2h2v2Zm1.07-7.75-.9.92A2.5 2.5 0 0 0 12 13h-1v-1a3.5 3.5 0 0 1 1.03-2.48l1.24-1.26a1.5 1.5 0 1 0-2.12-2.12 1.49 1.49 0 0 0-.44 1.06H9A3.5 3.5 0 1 1 14.07 9.25Z"/></svg>
              Guided tour
            </button>
        </div>
      </div>

      <!-- Form -->
      <form id="calcForm" class="p-4 md:p-6 space-y-6">
        <!-- Weight or Measurements -->
        <div id="panel-weight" class="grid grid-cols-1 gap-4 items-end">
            <div class="relative">
                <label for="weight" class="flex items-center gap-2 text-sm font-medium text-base-700">Horse Weight</label>
                <div class="flex gap-2 mt-1">
                    <input id="weight" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 1000" />
                    <select id="weightUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                        <option value="lb">lb</option> <option value="kg">kg</option>
                    </select>
                </div>
                 <p class="text-sm mt-2"><button type="button" id="btnEstimateMode" class="text-accent-700 hover:underline font-medium">Don't know the weight? Estimate from measurements →</button></p>
            </div>
        </div>

        <div id="panel-measure" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
          <div class="relative"><label for="hg" class="flex items-center gap-2 text-sm font-medium text-base-700">Heartgirth (HG)</label>
            <div class="flex gap-2 mt-1">
              <input id="hg" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 75" />
              <select id="hgUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                <option value="in">in</option> <option value="cm">cm</option>
              </select>
            </div>
          </div>
          <div class="relative">
            <label for="len" class="flex items-center gap-2 text-sm font-medium text-base-700">Body Length (L)</label>
            <div class="flex gap-2 mt-1">
              <input id="len" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 70" />
              <select id="lenUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                <option value="in">in</option> <option value="cm">cm</option>
              </select>
            </div>
          </div>
           <div class="sm:col-span-2 mt-2">
            <label class="text-sm font-medium text-base-700">Estimated Weight</label>
            <div class="mt-1 flex items-baseline gap-2">
              <output id="estWeight" class="text-2xl font-bold text-base-800">—</output> <span class="text-sm text-base-600">lb</span>
            </div>
          </div>
           <div class="relative sm:col-span-2"><p class="text-sm mt-2"><button type="button" id="btnWeightMode" class="text-accent-700 hover:underline font-medium">← Back to using actual weight</button></p></div>
        </div>

        <hr id="adjustments-hr" class="border-base-200">

        <!-- Clinical / fitness adjustments -->
        <div id="adjustments-panel">
            <h3 class="text-base md:text-lg font-semibold text-base-800">Clinical & Fitness Adjustments</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5 mt-4">
                <div id="bcsGroup" class="relative">
                    <label for="bcs" class="flex items-center gap-2 text-sm font-medium text-base-700">Body Condition Score (BCS)</label>
                    <input id="bcs" type="range" min="1" max="9" step="1" value="5" class="w-full accent-accent-600 mt-1">
                    <div class="flex justify-between text-xs text-base-600"><span>1</span><span id="bcsVal" class="font-medium text-base-800">5</span><span>9</span></div>
                </div>
                <div id="massGroup" class="relative">
                    <label for="mass" class="flex items-center gap-2 text-sm font-medium text-base-700">Muscle Atrophy (MASS)</label>
                    <input id="mass" type="range" min="1" max="4" step="1" value="1" class="w-full accent-accent-600 mt-1">
                    <div class="flex justify-between text-xs text-base-600"><span>1</span><span id="massVal" class="font-medium text-base-800">1</span><span>4</span></div>
                </div>
                <div id="fitnessGroup" class="relative">
                    <label for="fit" class="flex items-center gap-2 text-sm font-medium text-base-700">Overall Fitness</label>
                    <div class="flex gap-2 mt-1">
                      <label class="flex-1 flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-base-300 has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                        <input type="radio" name="fit" value="0" checked class="accent-accent-600"> Good
                      </label>
                      <label class="flex-1 flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-base-300 has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                        <input type="radio" name="fit" value="1" class="accent-accent-600"> Poor
                      </label>
                    </div>
                </div>
                <div id="asymGroup" class="relative">
                    <label for="asym" class="flex items-center gap-2 text-sm font-medium text-base-700">Gait Asymmetry</label>
                    <select id="asym" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2 mt-1">
                      <option value="0">0 — None</option> <option value="1">1 — Trot only</option> <option value="2">2 — Walk & trot</option>
                    </select>
                </div>
                <div class="relative sm:col-span-2">
                    <label class="flex items-center gap-2 text-sm font-medium text-base-700">Medical Concerns</label>
                    <label class="inline-flex items-center gap-2 text-sm mt-2 p-2 rounded-lg border border-transparent has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                    <input id="med" type="checkbox" class="accent-accent-600"> Concerns present
                    </label>
                </div>
            </div>
        </div>

        <hr class="border-base-200">

        <!-- Results -->
        <div id="results-panel">
          <div class="rounded-xl border border-base-200 p-4 bg-base-50">
            <div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3">
              <div><p class="text-sm text-base-600">Baseline (20%)</p><p id="baselineOut" class="text-xl font-semibold text-base-800">—</p></div>
              <div><p class="text-sm text-base-600">Reductions</p><p id="adjPctOut" class="text-xl font-semibold text-base-800">—</p></div>
              <div class="text-right flex-grow relative">
                <div class="flex items-center justify-end gap-2"><p class="text-sm text-base-600">Recommended Limit</p></div>
                <p id="wccOut" class="text-2xl md:text-3xl font-extrabold text-accent-700">—</p>
              </div>
            </div>

            <div class="mt-4">
              <div class="h-2 w-full bg-base-200 rounded-full overflow-hidden"><div id="bar" class="h-2 bg-accent-500 rounded-full transition-all duration-300" style="width: 0%"></div></div>
              <div class="mt-2 flex items-center justify-between">
                  <button type="button" id="saveSnapshotBtn" class="px-3 py-1.5 rounded-lg text-sm bg-accent-600 text-white hover:bg-accent-700 disabled:bg-base-300">
                    Save Snapshot
                  </button>
                  <button type="button" id="toggleDetailsBtn" class="text-sm text-accent-700 hover:underline font-medium">Show details</button>
              </div>
              <div id="detailsBreakdown" class="hidden mt-2 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs text-base-700 border-t border-base-200 pt-2">
                <div><span class="font-medium">BCS:</span> <span id="bcsAdj">—</span></div>
                <div><span class="font-medium">MASS:</span> <span id="massAdj">—</span></div>
                <div><span class="font-medium">Asym:</span> <span id="asymAdj">—</span></div>
                <div><span class="font-medium">Fitness:</span> <span id="fitAdj">—</span></div>
                <div><span class="font-medium">Medical:</span> <span id="medAdj">—</span></div>
              </div>
              <p id="warnMsg" class="hidden mt-3 text-sm px-3 py-2 rounded-lg bg-warn-100 text-warn-600 border border-warn-400">Check inputs: reductions exceeded baseline. Result was floored at 0.</p>
            </div>
          </div>
        </div>
      </form>
    </section>
  </main>
  
  <!-- MY STABLE MODAL -->
  <div id="stableModal" class="is-hidden fixed inset-0 flex items-center justify-center p-4">
    <div id="stableBackdrop" class="stable-backdrop"></div>
    <!-- List View -->
    <div id="stableViewList" class="modal-card relative w-full max-w-4xl bg-white/80 backdrop-blur-lg rounded-2xl shadow-soft ring-1 ring-base-300">
        <div class="flex items-center justify-between p-4 border-b border-base-200">
            <h3 class="text-lg font-semibold">My Stable</h3>
            <button id="stableCloseBtn" class="p-1 rounded-md hover:bg-base-100"><svg viewBox="0 0 24 24" class="w-5 h-5 text-base-600"><path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/></svg></button>
        </div>
        <div id="stableGrid" class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto">
            <!-- Horse cards will be rendered here -->
            <div id="addHorseCard" class="cursor-pointer flex flex-col items-center justify-center p-6 text-center bg-base-50 hover:bg-base-100 border-2 border-dashed border-base-300 rounded-xl transition">
                <div class="w-16 h-16 bg-accent-100 text-accent-600 rounded-full flex items-center justify-center mb-3"><svg viewBox="0 0 24 24" class="w-8 h-8"><path fill="currentColor" d="M19 12.998h-6v6h-2v-6H5v-2h6v-6h2v6h6z"/></svg></div>
                <p class="font-semibold text-base-800">Add New Horse</p>
                <p class="text-sm text-base-600">Create a profile to start tracking.</p>
            </div>
        </div>
    </div>
    <!-- Detail View -->
    <div id="stableViewDetail" class="hidden modal-card relative w-full max-w-4xl bg-white/80 backdrop-blur-lg rounded-2xl shadow-soft ring-1 ring-base-300">
        <div class="flex items-center justify-between p-4 border-b border-base-200">
            <button id="detailBackBtn" class="flex items-center gap-2 text-sm font-medium hover:bg-base-100 p-2 rounded-lg">
                <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg> Back to Stable
            </button>
            <h3 id="detailHorseName" class="text-lg font-semibold"></h3>
            <button id="detailCloseBtn" class="p-1 rounded-md hover:bg-base-100"><svg viewBox="0 0 24 24" class="w-5 h-5 text-base-600"><path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/></svg></button>
        </div>
        <div class="p-5 max-h-[70vh] overflow-y-auto">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-2 space-y-4">
                    <div id="detailPhotoContainer" class="relative group w-32 h-32 mx-auto">
                        <img id="detailHorsePhoto" src="" class="w-32 h-32 rounded-full object-cover bg-base-200 border-2 border-white shadow-md">
                        <label for="photoUpload" class="cursor-pointer absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg viewBox="0 0 24 24" class="w-6 h-6"><path fill="currentColor" d="m14.12 4.47 1.41 1.41L6.36 15.06l-1.41-1.41L14.12 4.47ZM16.24 2.34a1 1 0 0 1 1.42 0l2.12 2.12a1 1 0 0 1 0 1.42L8.23 17.41a1.011 1.011 0 0 1-.71.29H5a1 1 0 0 1-1-1v-2.5a1 1 0 0 1 .29-.71l11.95-11.95ZM20 20H4v-7.5l2-2 4 4 4.5-4.5 3.5 3.5V20Z"/></svg>
                        </label>
                        <input type="file" id="photoUpload" class="hidden" accept="image/*">
                    </div>
                    <div><label class="text-xs font-medium text-base-600">Notes</label><textarea id="detailHorseNotes" rows="4" class="w-full mt-1 p-2 border border-base-300 rounded-lg" placeholder="e.g., Slightly arthritic in right hock."></textarea></div>
                    <button id="saveHorseDetailsBtn" class="w-full px-3 py-1.5 rounded-lg text-sm bg-accent-600 text-white hover:bg-accent-700">Save Changes</button>
                    <button id="deleteHorseBtn" class="w-full text-sm text-red-600 hover:bg-red-50 p-2 rounded-lg">Delete Horse Profile</button>
                </div>
                <div class="lg:col-span-3">
                    <h4 class="font-semibold mb-2">History</h4>
                    <div class="mb-4"><canvas id="historyChart"></canvas></div>
                    <div id="snapshotList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>
  </div>


  <!-- TOUR (breadcrumbed informational pop-ups) -->
  <div id="tourBackdrop" class="hidden tour-backdrop"></div>
  <div id="tourCard" class="hidden fixed w-[calc(100%-2rem)] max-w-sm transition-position duration-300 ease-in-out">
    <div class="rounded-2xl shadow-soft border border-base-300 bg-white">
      <div class="px-4 py-3 border-b border-base-200 flex items-center justify-between">
        <p class="text-sm font-semibold text-base-800">Quick Tour</p>
        <button id="tourClose" class="p-1 rounded-md hover:bg-base-100" aria-label="Close tour"><svg viewBox="0 0 24 24" class="w-5 h-5 text-base-600"><path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/></svg></button>
      </div>
      <div class="px-4 py-4 space-y-3">
        <div id="tourStepTitle" class="text-base font-medium text-base-800"></div>
        <div id="tourStepBody" class="text-sm text-base-700"></div>
        <div class="flex items-center justify-between pt-2">
          <button id="tourPrev" class="px-3 py-2 rounded-lg text-sm border border-base-300 hover:bg-base-100">Back</button>
          <div class="flex items-center gap-2">
            <div id="tourDots" class="flex items-center gap-1"></div>
            <button id="tourNext" class="px-3 py-2 rounded-lg text-sm bg-accent-600 text-white hover:bg-accent-700">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  // ---------- Utilities ----------
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
  const parseNum = (el) => {
    const v = (typeof el === 'string') ? el : el.value;
    if (v === undefined || v === null) return NaN;
    const s = String(v).trim().replace(/,/g, '');
    if (!s) return NaN;
    return Number(s);
  };
  const fmtLb = (x) => isFinite(x) ? (Math.round(x)).toLocaleString() + " lb" : "—";
  const fmtPct = (x) => isFinite(x) ? (Math.round(x*1000)/10).toFixed(1) + "%" : "—";

  // ---------- Elements ----------
  const form = document.getElementById('calcForm');
  // ... (Existing calculator elements) ...
  const panelWeight = document.getElementById('panel-weight'), panelMeasure = document.getElementById('panel-measure');
  const btnEstimateMode = document.getElementById('btnEstimateMode'), btnWeightMode = document.getElementById('btnWeightMode');
  const weightEl = document.getElementById('weight'), weightUnitEl = document.getElementById('weightUnit');
  const hgEl = document.getElementById('hg'), lenEl = document.getElementById('len'), hgUnitEl = document.getElementById('hgUnit'), lenUnitEl = document.getElementById('lenUnit');
  const estWeightOut = document.getElementById('estWeight');
  const bcsEl = document.getElementById('bcs'), massEl = document.getElementById('mass'), asymEl = document.getElementById('asym'), fitEls = document.getElementsByName('fit'), medEl = document.getElementById('med');
  const bcsVal = document.getElementById('bcsVal'), massVal = document.getElementById('massVal');
  const baselineOut = document.getElementById('baselineOut'), adjPctOut = document.getElementById('adjPctOut'), wccOut = document.getElementById('wccOut');
  const bar = document.getElementById('bar'), toggleDetailsBtn = document.getElementById('toggleDetailsBtn'), detailsBreakdown = document.getElementById('detailsBreakdown');
  const bcsAdj = document.getElementById('bcsAdj'), massAdj = document.getElementById('massAdj'), asymAdj = document.getElementById('asymAdj'), fitAdj = document.getElementById('fitAdj'), medAdj = document.getElementById('medAdj');
  const warnMsg = document.getElementById('warnMsg');
  const tourStart = document.getElementById('tourStart');

  // ---------- NEW Stable Elements ----------
  const openStableBtn = document.getElementById('openStableBtn');
  const stableModal = document.getElementById('stableModal');
  const stableBackdrop = document.getElementById('stableBackdrop');
  const stableViewList = document.getElementById('stableViewList');
  const stableViewDetail = document.getElementById('stableViewDetail');
  const stableCloseBtn = document.getElementById('stableCloseBtn');
  const stableGrid = document.getElementById('stableGrid');
  const addHorseCard = document.getElementById('addHorseCard');
  const detailBackBtn = document.getElementById('detailBackBtn');
  const detailCloseBtn = document.getElementById('detailCloseBtn');
  const detailHorseName = document.getElementById('detailHorseName');
  const detailHorsePhoto = document.getElementById('detailHorsePhoto');
  const photoUpload = document.getElementById('photoUpload');
  const detailHorseNotes = document.getElementById('detailHorseNotes');
  const saveHorseDetailsBtn = document.getElementById('saveHorseDetailsBtn');
  const deleteHorseBtn = document.getElementById('deleteHorseBtn');
  const historyChartCanvas = document.getElementById('historyChart');
  const snapshotList = document.getElementById('snapshotList');
  const saveSnapshotBtn = document.getElementById('saveSnapshotBtn');
  const activeHorseIndicator = document.getElementById('activeHorseIndicator');
  const activeHorseName = document.getElementById('activeHorseName');

  // ---------- App State ----------
  let data = { horses: [] };
  let activeHorseId = null;
  let activeDetailHorseId = null;
  let historyChart = null;
  let mode = 'weight'; // 'weight' or 'measure'
  
  // ---------- Data Layer (localStorage) ----------
  const STORAGE_KEY = 'horseWCCData';
  function loadData() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            data = JSON.parse(storedData);
        } else {
            data = { horses: [] };
        }
    } catch (e) {
        console.error("Could not load data from localStorage", e);
        data = { horses: [] };
    }
  }
  function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error("Could not save data to localStorage", e);
    }
  }
  
  // ---------- Core Logic (Horses & Snapshots) ----------
  function createHorse(name) {
    const newHorse = {
      id: self.crypto.randomUUID(),
      name: name.trim(),
      notes: "",
      photoUrl: "",
      snapshots: []
    };
    data.horses.push(newHorse);
    saveData();
    return newHorse;
  }

  function getHorse(id) {
    return data.horses.find(h => h.id === id);
  }

  function updateHorseDetails(id, { name, notes, photoUrl }) {
    const horse = getHorse(id);
    if (!horse) return;
    if (name !== undefined) horse.name = name.trim();
    if (notes !== undefined) horse.notes = notes;
    if (photoUrl !== undefined) horse.photoUrl = photoUrl;
    saveData();
  }

  function deleteHorse(id) {
    data.horses = data.horses.filter(h => h.id !== id);
    if (activeHorseId === id) {
      clearActiveHorse();
    }
    saveData();
  }

  function addSnapshot(horseId) {
    const horse = getHorse(horseId);
    if (!horse) return;
    const w = getWeightLb();
    if (!isFinite(w)) {
      alert("Cannot save snapshot without a valid weight.");
      return;
    }
    const snapshot = {
      date: new Date().toISOString(),
      mode: mode,
      weight: parseNum(weightEl),
      weightUnit: weightUnitEl.value,
      hg: parseNum(hgEl), hgUnit: hgUnitEl.value,
      len: parseNum(lenEl), lenUnit: lenUnitEl.value,
      bcs: Number(bcsEl.value),
      mass: Number(massEl.value),
      fit: currentFit(),
      asym: Number(asymEl.value),
      med: medEl.checked,
      calculatedWCC: parseNum(wccOut.textContent.replace(/ lb|,/g, ''))
    };
    horse.snapshots.unshift(snapshot); // Add to beginning
    saveData();
  }
  
  function deleteSnapshot(horseId, date) {
      const horse = getHorse(horseId);
      if (!horse) return;
      horse.snapshots = horse.snapshots.filter(s => s.date !== date);
      saveData();
      renderHorseDetail(horseId); // Re-render the detail view
  }

  function loadSnapshotToCalculator(horseId, date) {
    const horse = getHorse(horseId);
    if (!horse) return;
    const snapshot = horse.snapshots.find(s => s.date === date);
    if (!snapshot) return;

    setMode(snapshot.mode);
    weightEl.value = snapshot.weight || '';
    weightUnitEl.value = snapshot.weightUnit || 'lb';
    hgEl.value = snapshot.hg || '';
    hgUnitEl.value = snapshot.hgUnit || 'in';
    lenEl.value = snapshot.len || '';
    lenUnitEl.value = snapshot.lenUnit || 'in';
    bcsEl.value = snapshot.bcs;
    massEl.value = snapshot.mass;
    document.querySelector(`input[name="fit"][value="${snapshot.fit}"]`).checked = true;
    asymEl.value = snapshot.asym;
    medEl.checked = snapshot.med;

    setActiveHorse(horse.id);
    closeStableModal();
    calculate();
    form.scrollIntoView({ behavior: 'smooth' });
  }

  function setActiveHorse(id) {
    activeHorseId = id;
    const horse = getHorse(id);
    if (horse) {
      activeHorseName.textContent = horse.name;
      activeHorseIndicator.classList.remove('hidden');
    }
    calculate();
  }

  function clearActiveHorse() {
    activeHorseId = null;
    activeHorseIndicator.classList.add('hidden');
    calculate();
  }
  
  // ---------- Rendering ----------
  function renderStableList() {
    stableGrid.innerHTML = '';
    data.horses.forEach(horse => {
      const lastSnapshot = horse.snapshots[0];
      const lastWCC = lastSnapshot ? fmtLb(lastSnapshot.calculatedWCC) : 'N/A';
      const lastDate = lastSnapshot ? new Date(lastSnapshot.date).toLocaleDateString() : 'No data';
      const photoSrc = horse.photoUrl || `https://placehold.co/128x128/eef2f7/263a4d?text=${horse.name.charAt(0)}`;
      
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-xl shadow-md space-y-3';
      card.innerHTML = `
        <div class="flex items-center gap-4">
          <img src="${photoSrc}" alt="${horse.name}" class="w-16 h-16 rounded-full object-cover bg-base-100">
          <div>
            <p class="font-bold text-lg text-base-800">${horse.name}</p>
            <p class="text-xs text-base-600">Last measured: ${lastDate}</p>
            <p class="text-sm font-medium">Last WCC: <span class="font-bold text-accent-700">${lastWCC}</span></p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <button data-action="load" data-id="${horse.id}" ${!lastSnapshot ? 'disabled' : ''} class="w-full text-center px-3 py-1.5 rounded-lg border border-base-300 hover:bg-base-100 disabled:opacity-50">Load Latest</button>
          <button data-action="detail" data-id="${horse.id}" class="w-full text-center px-3 py-1.5 rounded-lg bg-accent-600 text-white hover:bg-accent-700">View History</button>
        </div>
      `;
      stableGrid.appendChild(card);
    });
    stableGrid.appendChild(addHorseCard);
  }

  function renderHorseDetail(id) {
    activeDetailHorseId = id;
    const horse = getHorse(id);
    if (!horse) return;

    detailHorseName.textContent = horse.name;
    detailHorsePhoto.src = horse.photoUrl || `https://placehold.co/128x128/eef2f7/263a4d?text=${horse.name.charAt(0)}`;
    detailHorseNotes.value = horse.notes;

    snapshotList.innerHTML = '';
    if (horse.snapshots.length === 0) {
        snapshotList.innerHTML = `<p class="text-center text-sm text-base-600 py-4">No snapshots saved yet.</p>`;
    }
    horse.snapshots.forEach(s => {
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between p-2 bg-base-50 rounded-lg';
      el.innerHTML = `
        <div>
          <p class="font-medium text-sm">${new Date(s.date).toLocaleString()}</p>
          <p class="text-xs text-base-600">WCC: <span class="font-bold text-accent-700">${fmtLb(s.calculatedWCC)}</span> | BCS: ${s.bcs} | Weight: ${fmtLb(s.mode === 'weight' ? s.weight : (s.hg*s.hg*s.len)/330)}</p>
        </div>
        <div class="flex gap-1">
            <button data-action="load-snapshot" data-date="${s.date}" class="p-1.5 rounded-md hover:bg-base-200" title="Load"><svg class="w-4 h-4 text-base-600" viewBox="0 0 24 24"><path fill="currentColor" d="M3 3h18v2H3V3m11 16.5V17h4v-2h-4v-2.5l-4 4 4 4M5 19v-8h6v8H5m2-6v4h2v-4H7Z"/></svg></button>
            <button data-action="delete-snapshot" data-date="${s.date}" class="p-1.5 rounded-md hover:bg-red-100" title="Delete"><svg class="w-4 h-4 text-red-600" viewBox="0 0 24 24"><path fill="currentColor" d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12Z"/></svg></button>
        </div>
      `;
      snapshotList.appendChild(el);
    });
    drawHistoryChart(horse);
  }

  function drawHistoryChart(horse) {
    if (historyChart) {
      historyChart.destroy();
    }
    const reversedSnapshots = [...horse.snapshots].reverse();
    const labels = reversedSnapshots.map(s => new Date(s.date).toLocaleDateString());
    const wccData = reversedSnapshots.map(s => s.calculatedWCC);
    const bcsData = reversedSnapshots.map(s => s.bcs);
    const weightData = reversedSnapshots.map(s => {
      if (s.mode === 'weight' && isFinite(s.weight)) {
          return s.weightUnit === 'kg' ? s.weight * 2.20462 : s.weight;
      }
      const hgIn = s.hgUnit === 'cm' ? s.hg / 2.54 : s.hg;
      const lenIn = s.lenUnit === 'cm' ? s.len / 2.54 : s.len;
      if(isFinite(hgIn) && isFinite(lenIn)) return (hgIn * hgIn * lenIn) / 330;
      return null;
    });

    historyChart = new Chart(historyChartCanvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'WCC (lb)', data: wccData, borderColor: tailwind.config.theme.extend.colors.accent[600], yAxisID: 'y' },
                { label: 'Weight (lb)', data: weightData, borderColor: tailwind.config.theme.extend.colors.base[400], yAxisID: 'y' },
                { label: 'BCS', data: bcsData, borderColor: tailwind.config.theme.extend.colors.warn[400], yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { type: 'linear', display: true, position: 'left' },
                y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, min: 1, max: 9 }
            }
        }
    });
  }

  // ---------- UI Interaction ----------
  function openStableModal() { stableModal.classList.remove('is-hidden'); }
  function closeStableModal() { stableModal.classList.add('is-hidden'); }
  
  function showListView() {
    stableViewDetail.classList.add('hidden');
    stableViewList.classList.remove('hidden');
    renderStableList();
  }
  function showDetailView(id) {
    renderHorseDetail(id);
    stableViewList.classList.add('hidden');
    stableViewDetail.classList.remove('hidden');
  }

  openStableBtn.addEventListener('click', () => {
      showListView();
      openStableModal();
  });
  [stableCloseBtn, detailCloseBtn, stableBackdrop].forEach(el => el.addEventListener('click', closeStableModal));
  detailBackBtn.addEventListener('click', showListView);
  
  addHorseCard.addEventListener('click', () => {
    const name = prompt("Enter the new horse's name:");
    if (name && name.trim()) {
      createHorse(name);
      renderStableList();
    }
  });

  stableGrid.addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;
      const { action, id } = button.dataset;
      if (action === 'detail') {
          showDetailView(id);
      } else if (action === 'load') {
          const horse = getHorse(id);
          if (horse && horse.snapshots.length > 0) {
              loadSnapshotToCalculator(id, horse.snapshots[0].date);
          }
      }
  });

  snapshotList.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button) return;
    const { action, date } = button.dataset;
    if (action === 'load-snapshot') {
      loadSnapshotToCalculator(activeDetailHorseId, date);
    } else if (action === 'delete-snapshot') {
      if (confirm('Are you sure you want to delete this snapshot?')) {
        deleteSnapshot(activeDetailHorseId, date);
      }
    }
  });
  
  saveHorseDetailsBtn.addEventListener('click', () => {
    const horse = getHorse(activeDetailHorseId);
    if (!horse) return;

    const newName = prompt("Enter new name:", horse.name);
    if (newName && newName.trim()) {
      updateHorseDetails(activeDetailHorseId, {
        name: newName,
        notes: detailHorseNotes.value // Also save notes
      });
      detailHorseName.textContent = newName;
      alert("Details saved.");
    }
  });

  deleteHorseBtn.addEventListener('click', () => {
      if (confirm(`Are you sure you want to permanently delete ${getHorse(activeDetailHorseId).name}? This cannot be undone.`)) {
          deleteHorse(activeDetailHorseId);
          showListView();
      }
  });
  
  photoUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageUrl = event.target.result;
        updateHorseDetails(activeDetailHorseId, { photoUrl: imageUrl });
        detailHorsePhoto.src = imageUrl;
      };
      reader.readAsDataURL(file);
    }
  });
  
  saveSnapshotBtn.addEventListener('click', () => {
    if (activeHorseId) {
      addSnapshot(activeHorseId);
      alert(`Snapshot saved for ${getHorse(activeHorseId).name}.`);
    } else {
      if (data.horses.length === 0) {
          alert('Please create a horse profile first in "My Stable".');
          return;
      }
      // Simple prompt to select horse
      const horseNames = data.horses.map((h, i) => `${i + 1}: ${h.name}`).join('\n');
      const choice = prompt(`Select a horse to save this snapshot to:\n${horseNames}`);
      const index = parseInt(choice, 10) - 1;
      if (isFinite(index) && data.horses[index]) {
          const horse = data.horses[index];
          addSnapshot(horse.id);
          setActiveHorse(horse.id);
          alert(`Snapshot saved for ${horse.name}.`);
      }
    }
  });


  // ---------- ORIGINAL SCRIPT ----------
  // ... (Mode switching, Popovers, Tour are kept as is) ...
  // Mode switching
  function setMode(m) {
    mode = m;
    if (mode === 'weight') {
      panelWeight.classList.remove('hidden');
      panelMeasure.classList.add('hidden');
    } else {
      panelWeight.classList.add('hidden');
      panelMeasure.classList.remove('hidden');
    }
    calculate();
  }
  btnEstimateMode?.addEventListener('click', () => setMode('measure'));
  btnWeightMode?.addEventListener('click', () => setMode('weight'));
  toggleDetailsBtn.addEventListener('click', () => {
    const isHidden = detailsBreakdown.classList.toggle('hidden');
    toggleDetailsBtn.textContent = isHidden ? 'Show details' : 'Hide details';
  });

  // Tour (omitted for brevity, assume it exists and works)
  const tourBackdrop = document.getElementById('tourBackdrop');
  tourStart.addEventListener('click', () => tourBackdrop.classList.remove('hidden')); // Simplified for example
  tourBackdrop.addEventListener('click', () => tourBackdrop.classList.add('hidden'));


  // Calculations
  function currentFit() {
    for (const r of fitEls) if (r.checked) return Number(r.value);
    return 0;
  }

  function getWeightLb() {
    if (mode === 'weight') {
      const w = parseNum(weightEl);
      if (!isFinite(w)) return NaN;
      return (weightUnitEl.value === 'kg') ? w * 2.2046226218 : w;
    } else {
      const hg = parseNum(hgEl); const len = parseNum(lenEl);
      if (!isFinite(hg) || !isFinite(len)) { estWeightOut.textContent = "—"; return NaN; };
      const hgIn = (hgUnitEl.value === 'cm') ? (hg / 2.54) : hg;
      const lenIn = (lenUnitEl.value === 'cm') ? (len / 2.54) : len;
      const weight = (hgIn * hgIn * lenIn) / 330.0;
      estWeightOut.textContent = isFinite(weight) ? Math.round(weight).toLocaleString() : "—";
      return weight;
    }
  }

  function calculate() {
    bcsVal.textContent = bcsEl.value;
    massVal.textContent = massEl.value;
    const weightLb = getWeightLb();
    const baseline = isFinite(weightLb) ? 0.20 * weightLb : NaN;

    const bcs = Number(bcsEl.value), mass = Number(massEl.value), asym = Number(asymEl.value), fit  = currentFit(), med  = medEl.checked ? 1 : 0;
    const redBCS  = Math.abs(5 - bcs) / 10, redMASS = Math.abs(1 - mass) / 10, redASYM = asym / 10, redFIT  = 0.25 * fit, redMED  = 0.25 * med;
    const totalReduction = redBCS + redMASS + redASYM + redFIT + redMED;
    let wcc = isFinite(baseline) ? baseline * (1 - totalReduction) : NaN;
    let floored = false;
    if (isFinite(wcc) && wcc < 0) { wcc = 0; floored = true; }

    baselineOut.textContent = fmtLb(baseline);
    adjPctOut.textContent   = isFinite(totalReduction) ? "−" + fmtPct(totalReduction) : "—";
    wccOut.textContent      = isFinite(wcc) ? fmtLb(wcc) : "—";
    bcsAdj.textContent  = "−" + fmtPct(redBCS), massAdj.textContent = "−" + fmtPct(redMASS), asymAdj.textContent = "−" + fmtPct(redASYM), fitAdj.textContent  = "−" + fmtPct(redFIT), medAdj.textContent  = "−" + fmtPct(redMED);
    const pct = (isFinite(baseline) && baseline > 0 && isFinite(wcc)) ? clamp((wcc / baseline) * 100, 0, 100) : 0;
    bar.style.width = pct + "%";
    warnMsg.classList.toggle('hidden', !floored);
    
    // Update snapshot button state
    saveSnapshotBtn.disabled = !isFinite(wcc);
    if(activeHorseId) {
        saveSnapshotBtn.textContent = `Save to ${getHorse(activeHorseId).name}`;
    } else {
        saveSnapshotBtn.textContent = 'Save Snapshot';
    }
  }

  // ---------- Initialization ----------
  [ weightEl, weightUnitEl, hgEl, lenEl, hgUnitEl, lenUnitEl, bcsEl, massEl, asymEl, medEl ].forEach(el => el.addEventListener('input', calculate));
  fitEls.forEach(el => el.addEventListener('change', calculate));
  
  loadData();
  setMode('weight');
  calculate();
  
  // Initialize KaTeX rendering after the main script setup
  if (window.renderMathInElement) {
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '\\(', right: '\\)', display: false}
        ]
    });
  }
  </script>

  <!-- Footer -->
  <footer class="fixed left-0 right-0 bottom-0 pointer-events-none">
    <div class="max-w-3xl mx-auto px-4 pb-4 flex justify-end">
      <div class="pointer-events-auto px-3 py-1.5 rounded-lg bg-white/70 backdrop-blur text-[11px] text-base-700 ring-1 ring-base-300">
        For field guidance only. Always consider the individual horse and professional judgment.
      </div>
    </div>
  </footer>
</body>
</html>


