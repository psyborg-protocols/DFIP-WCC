<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horse Weight Carrying Capacity Calculator</title>
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- KaTeX (lightweight math typesetting) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
          onload="renderMathInElement(document.body, {delimiters:[{left:'$$', right:'$$', display:true},{left:'\\\\(', right:'\\\\)', display:false}]});"></script>
  <script>
    // Tailwind config: modern, accessible palette
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base: {
              50:  "#f6f8fa",
              100: "#eef2f7",
              200: "#e1e8ef",
              300: "#cbd6e2",
              400: "#9fb3c8",
              500: "#6b8eb1",
              600: "#4b6f94",
              700: "#395976",
              800: "#2e475e",
              900: "#263a4d"
            },
            accent: {
              50:  "#f0fdf6",
              100: "#dcfce7",
              200: "#bbf7d0",
              300: "#86efac",
              400: "#4ade80",
              500: "#22c55e",
              600: "#16a34a",
              700: "#15803d",
              800: "#166534",
              900: "#14532d"
            },
            warn: {
              100: "#fff7ed",
              400: "#fb923c",
              600: "#ea580c"
            }
          },
          boxShadow: {
            soft: "0 10px 30px rgba(20, 35, 55, 0.15)",
            highlight: "0 0 0 4px rgba(34, 197, 94, 0.6)"
          },
          fontFamily: {
            ui: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji'],
            mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace']
          },
          transitionProperty: {
            'position': 'top, left, right, bottom',
          },
        }
      }
    }
  </script>
  <style>
    /* Background image placeholder — replace URL below with your own image */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:url('https://images.unsplash.com/photo-1545464333-9f338f5f0c47?q=80&w=1600&auto=format&fit=crop'); /* <-- Replace or remove */
      background-size:cover;
      background-position:center;
      filter:brightness(0.9) saturate(1.05);
      z-index:-2;
    }
    /* Subtle vignette overlay for contrast */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:radial-gradient(ellipse at center, rgba(10,20,30,.0) 0%, rgba(10,20,30,.25) 60%, rgba(10,20,30,.55) 100%);
      z-index:-1;
    }
    /* Simple tooltip/popover base (non-intrusive) */
    .popover {
      position: absolute;
      transform: translateY(8px);
      min-width: 260px;
      z-index: 50;
    }
    .hidden-vis {
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear .1s, opacity .1s ease-in-out;
    }
    .shown-vis {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    /* Tour styles */
    .tour-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 9998;
    }
    #tourCard { z-index: 9999; }
    .tour-highlight {
      position: relative;
      z-index: 9999;
      box-shadow: var(--tw-shadow-highlight);
      border-radius: 0.75rem;
      transition: box-shadow .3s ease-in-out;
    }
  </style>
</head>
<body class="min-h-screen font-ui text-base-900 bg-base-50">
  <header class="max-w-3xl mx-auto px-4 pt-8 pb-2 md:pt-10">
    <div class="flex items-center gap-3">
      <div class="p-2 rounded-xl bg-accent-100 ring-1 ring-accent-300/60">
        <!-- Inline SVG logo -->
        <svg aria-hidden="true" viewBox="0 0 24 24" class="w-6 h-6 text-accent-700">
          <path fill="currentColor" d="M3 18c0-2 2-4 4-4h2l3-6 2 4h3a4 4 0 0 1 4 4v2H3v-2Z"/>
        </svg>
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-white drop-shadow">Horse Weight Carrying Capacity</h1>
        <p class="text-base-200 text-sm">Modern, field-friendly calculator using the 20% baseline with clinical and fitness adjustments</p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 pb-20">
    <section class="bg-white/90 backdrop-blur rounded-2xl shadow-soft ring-1 ring-base-300 overflow-hidden">
      <!-- Top bar -->
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center justify-between p-4 md:p-5 bg-base-50/70 border-b border-base-200">
        <div class="flex items-center gap-2">
          <h2 class="text-base md:text-lg font-semibold text-base-800">Calculator</h2>
        </div>
        <button id="tourStart" class="inline-flex w-full sm:w-auto items-center justify-center gap-2 text-accent-700 hover:text-accent-800 text-sm font-medium px-2.5 py-1.5 rounded-md bg-accent-100 hover:bg-accent-200 ring-1 ring-accent-200 transition">
          <svg aria-hidden="true" viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 15h-2v-2h2v2Zm1.07-7.75-.9.92A2.5 2.5 0 0 0 12 13h-1v-1a3.5 3.5 0 0 1 1.03-2.48l1.24-1.26a1.5 1.5 0 1 0-2.12-2.12 1.49 1.49 0 0 0-.44 1.06H9A3.5 3.5 0 1 1 14.07 9.25Z"/></svg>
          Guided tour
        </button>
      </div>

      <!-- Form -->
      <form id="calcForm" class="p-4 md:p-6 space-y-6">
        <!-- Weight or Measurements -->
        <div id="panel-weight" class="grid grid-cols-1 gap-4 items-end">
            <div class="relative">
                <label for="weight" class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Horse Weight
                    <button type="button" class="info-btn relative" data-pop="pop-weight" aria-label="Explain Horse Weight">
                        <span class="sr-only">Info</span>
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-weight" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                        <p class="mb-2">Enter actual scale or tape weight. The measurement estimator uses the standard formula:</p>
                        <p class="font-mono text-xs text-center py-1 bg-base-50 rounded">(HG² × L) / 330</p>
                    </div>
                </label>
                <div class="flex gap-2 mt-1">
                    <input id="weight" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 1000" />
                    <select id="weightUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                        <option value="lb">lb</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
                 <p class="text-sm mt-2">
                    <button type="button" id="btnEstimateMode" class="text-accent-700 hover:underline font-medium">
                        Don't know the weight? Estimate from measurements →
                    </button>
                </p>
            </div>
        </div>

        <div id="panel-measure" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 items-end border-t border-base-200 pt-6">
          <div class="relative sm:col-span-2">
             <p class="text-sm">
                <button type="button" id="btnWeightMode" class="text-accent-700 hover:underline font-medium">
                    ← Back to using actual weight
                </button>
            </p>
          </div>
          <div class="relative">
            <label for="hg" class="flex items-center gap-2 text-sm font-medium text-base-700">
              Heartgirth (HG)
              <button type="button" class="info-btn relative" data-pop="pop-hg" aria-label="Explain Heartgirth">
                <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
              </button>
              <div id="pop-hg" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                Measure circumference just behind the elbow and over the highest point of the withers. Keep the tape level and snug.
              </div>
            </label>
            <div class="flex gap-2 mt-1">
              <input id="hg" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 75" />
              <select id="hgUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                <option value="in">in</option>
                <option value="cm">cm</option>
              </select>
            </div>
          </div>
          <div class="relative">
            <label for="len" class="flex items-center gap-2 text-sm font-medium text-base-700">
              Body Length (L)
              <button type="button" class="info-btn relative" data-pop="pop-len" aria-label="Explain Length">
                <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
              </button>
              <div id="pop-len" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                Measure from the point of shoulder to the point of buttock in a straight line. Keep the tape taut and level with the ground.
              </div>
            </label>
            <div class="flex gap-2 mt-1">
              <input id="len" inputmode="decimal" type="text" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2" placeholder="e.g., 70" />
              <select id="lenUnit" class="rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-2 py-2">
                <option value="in">in</option>
                <option value="cm">cm</option>
              </select>
            </div>
          </div>
           <div class="sm:col-span-2 mt-2">
            <label class="text-sm font-medium text-base-700">Estimated Weight</label>
            <div class="mt-1 flex items-baseline gap-2">
              <output id="estWeight" class="text-2xl font-bold text-base-800">—</output>
              <span class="text-sm text-base-600">lb</span>
            </div>
          </div>
        </div>

        <hr id="adjustments-hr" class="border-base-200">

        <!-- Clinical / fitness adjustments -->
        <div id="adjustments-panel">
            <h3 class="text-base md:text-lg font-semibold text-base-800">Clinical & Fitness Adjustments</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5 mt-4">
                <div id="bcsGroup" class="relative">
                    <label for="bcs" class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Body Condition Score (BCS)
                    <button type="button" class="info-btn relative" data-pop="pop-bcs" aria-label="Explain BCS">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-bcs" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                      <p class="mb-2"><strong>BCS 1–9 (ideal ≈ 5)</strong> rates <em>fat cover</em> at six sites (neck, withers, behind shoulder, ribs, loin, tailhead). Use palpation + visual check.</p>
                      <p class="text-xs"><a href="https://ohioline.osu.edu/factsheet/as-1024" target="_blank" class="text-accent-700 underline">Learn BCS (OSU Ohioline)</a></p>
                    </div>
                    </label>
                    <input id="bcs" type="range" min="1" max="9" step="1" value="5" class="w-full accent-accent-600 mt-1">
                    <div class="flex justify-between text-xs text-base-600"><span>1</span><span id="bcsVal" class="font-medium text-base-800">5</span><span>9</span></div>
                </div>

                <div id="massGroup" class="relative">
                    <label for="mass" class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Muscle Atrophy (MASS)
                    <button type="button" class="info-btn relative" data-pop="pop-mass" aria-label="Explain MASS">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-mass" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                      <p class="mb-2"><strong>MASS 1–4 (1 = none, 4 = severe)</strong> screens <em>muscle loss</em> by region (neck, back, hindquarters). Score each side and note asymmetry.</p>
                      <p class="text-xs"><a href="https://www.spillers-feeds.com/muscle-wastage-scoring-guide" target="_blank" class="text-accent-700 underline">MASS guide (owner-friendly)</a></p>
                    </div>
                    </label>
                    <input id="mass" type="range" min="1" max="4" step="1" value="1" class="w-full accent-accent-600 mt-1">
                    <div class="flex justify-between text-xs text-base-600"><span>1</span><span id="massVal" class="font-medium text-base-800">1</span><span>4</span></div>
                </div>

                <div id="asymGroup" class="relative">
                    <label for="asym" class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Gait Asymmetry (during fitness test)
                    <button type="button" class="info-btn relative" data-pop="pop-asym" aria-label="Explain Asymmetry">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-asym" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                      <p class="mb-2">Assess gait <em>during the fitness test</em>. Mark asymmetry if irregularities are visible at trot (1) or at walk &amp; trot (2).</p>
                      <p class="text-xs"><a href="https://example.com/symmetry-guide" target="_blank" class="text-accent-700 underline">Symmetry how-to (placeholder)</a></p>
                    </div>
                    </label>
                    <select id="asym" class="w-full rounded-lg border-base-300 focus:ring-accent-500 focus:border-accent-500 border px-3 py-2 mt-1">
                      <option value="0">0 — None</option>
                      <option value="1">1 — Trot only</option>
                      <option value="2">2 — Walk & trot</option>
                    </select>
                </div>

                <div id="fitnessGroup" class="relative">
                    <label for="fit" class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Overall Fitness (from field test)
                    <button type="button" class="info-btn relative" data-pop="pop-fit" aria-label="Explain Fitness">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-fit" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                      <p class="mb-2"><strong>Field fitness test:</strong> Record resting HR → walk 5 min → trot 3 min → record HR immediately, at 3 min, and at 5 min. <em>Aim</em>: HR back to baseline by 5 min.</p>
                      <p class="text-xs"><a href="https://example.com/fitness-test" target="_blank" class="text-accent-700 underline">Fitness test protocol (placeholder)</a></p>
                    </div>
                    </label>
                    <div class="flex gap-2 mt-1">
                      <label class="flex-1 flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-base-300 has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                        <input type="radio" name="fit" value="0" checked class="accent-accent-600"> Good
                      </label>
                      <label class="flex-1 flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-base-300 has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                        <input type="radio" name="fit" value="1" class="accent-accent-600"> Poor
                      </label>
                    </div>
                </div>

                <div class="relative sm:col-span-2">
                    <label class="flex items-center gap-2 text-sm font-medium text-base-700">
                    Medical Concerns
                    <button type="button" class="info-btn relative" data-pop="pop-med" aria-label="Explain Medical Concerns">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-med" class="popover hidden-vis left-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft">
                        Flag if present: arthritis, COPD/heaves, orthopedic issues, Cushing’s, etc. If checked, reduces baseline by 25%.
                    </div>
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm mt-2 p-2 rounded-lg border border-transparent has-[:checked]:bg-accent-50 has-[:checked]:border-accent-400">
                    <input id="med" type="checkbox" class="accent-accent-600">
                    Concerns present
                    </label>
                </div>
            </div>
        </div>

        <hr class="border-base-200">

        <!-- Results -->
        <div id="results-panel">
          <div class="rounded-xl border border-base-200 p-4 bg-base-50">
            <div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3">
              <div>
                <p class="text-sm text-base-600">Baseline (20% of weight)</p>
                <p id="baselineOut" class="text-xl font-semibold text-base-800">—</p>
              </div>
              <div>
                <p class="text-sm text-base-600">Total Reductions</p>
                <p id="adjPctOut" class="text-xl font-semibold text-base-800">—</p>
              </div>
              <div class="text-right flex-grow relative">
                <div class="flex items-center justify-end gap-2">
                    <p class="text-sm text-base-600">Recommended Limit</p>
                    <button type="button" class="info-btn relative -top-px" data-pop="pop-formula" aria-label="Explain Formula">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 text-base-600"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/><path d="M11 10h2v6h-2v-6Zm0-3h2v2h-2V7Z" fill="currentColor"/></svg>
                    </button>
                    <div id="pop-formula" class="popover hidden-vis right-0 top-6 bg-white border border-base-200 rounded-lg p-3 text-sm shadow-soft max-w-xs w-72">
                        <p class="text-xs text-left text-base-600 mb-2">Full calculation formula:</p>
                        <div class="text-left text-xs break-words">
                        $$ \text{WCC} = \text{Wt} \times 0.20 \times \Big(1 - \sum R \Big) $$
                        <p class="text-xs text-left text-base-600 mt-2">Where the sum of reductions <span class="font-mono">∑ R</span> is:</p>
                        $$ \tfrac{|5-\text{BCS}|}{10} + \tfrac{|\text{1-MASS}|}{10} + \tfrac{\text{ASYM}}{10} + (0.25 \cdot \text{FIT}) + (0.25 \cdot \text{MED}) $$
                        </div>
                    </div>
                </div>
                <p id="wccOut" class="text-2xl md:text-3xl font-extrabold text-accent-700">—</p>
              </div>
            </div>

            <!-- Progress bar -->
            <div class="mt-4">
              <div class="h-2 w-full bg-base-200 rounded-full overflow-hidden">
                <div id="bar" class="h-2 bg-accent-500 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="mt-2 text-right">
                  <button type="button" id="toggleDetailsBtn" class="text-sm text-accent-700 hover:underline font-medium">Show details</button>
              </div>
              <div id="detailsBreakdown" class="hidden mt-2 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs text-base-700 border-t border-base-200 pt-2">
                <div><span class="font-medium">BCS:</span> <span id="bcsAdj">—</span></div>
                <div><span class="font-medium">MASS:</span> <span id="massAdj">—</span></div>
                <div><span class="font-medium">Asym:</span> <span id="asymAdj">—</span></div>
                <div><span class="font-medium">Fitness:</span> <span id="fitAdj">—</span></div>
                <div><span class="font-medium">Medical:</span> <span id="medAdj">—</span></div>
              </div>
              <p id="warnMsg" class="hidden mt-3 text-sm px-3 py-2 rounded-lg bg-warn-100 text-warn-600 border border-warn-400">
                Check inputs: reductions exceeded baseline. Result was floored at 0.
              </p>
            </div>
          </div>

        </div>
      </form>
    </section>
  </main>

  <!-- TOUR (breadcrumbed informational pop-ups) -->
  <div id="tourBackdrop" class="hidden tour-backdrop"></div>
  <div id="tourCard" class="hidden fixed w-[calc(100%-2rem)] max-w-sm transition-position duration-300 ease-in-out">
    <div class="rounded-2xl shadow-soft border border-base-300 bg-white">
      <div class="px-4 py-3 border-b border-base-200 flex items-center justify-between">
        <p class="text-sm font-semibold text-base-800">Quick Tour</p>
        <button id="tourClose" class="p-1 rounded-md hover:bg-base-100" aria-label="Close tour">
          <svg viewBox="0 0 24 24" class="w-5 h-5 text-base-600"><path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.41 4.29 19.71 2.87 18.29 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"/></svg>
        </button>
      </div>
      <div class="px-4 py-4 space-y-3">
        <div id="tourStepTitle" class="text-base font-medium text-base-800"></div>
        <div id="tourStepBody" class="text-sm text-base-700"></div>
        <div class="flex items-center justify-between pt-2">
          <button id="tourPrev" class="px-3 py-2 rounded-lg text-sm border border-base-300 hover:bg-base-100">Back</button>
          <div class="flex items-center gap-2">
            <div id="tourDots" class="flex items-center gap-1"></div>
            <button id="tourNext" class="px-3 py-2 rounded-lg text-sm bg-accent-600 text-white hover:bg-accent-700">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ---------- Utilities ----------
  const clamp = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
  const parseNum = (el) => {
    const v = (typeof el === 'string') ? el : el.value;
    if (v === undefined || v === null) return NaN;
    const s = String(v).trim().replace(/,/g, '');
    if (!s) return NaN;
    return Number(s);
  };
  const fmtLb = (x) => isFinite(x) ? (Math.round(x)).toLocaleString() + " lb" : "—";
  const fmtPct = (x) => isFinite(x) ? (Math.round(x*1000)/10).toFixed(1) + "%" : "—";

  // ---------- Elements ----------
  const form = document.getElementById('calcForm');

  const panelWeight = document.getElementById('panel-weight');
  const panelMeasure = document.getElementById('panel-measure');
  const btnEstimateMode = document.getElementById('btnEstimateMode');
  const btnWeightMode = document.getElementById('btnWeightMode');

  const weightEl = document.getElementById('weight');
  const weightUnitEl = document.getElementById('weightUnit');
  
  const hgEl = document.getElementById('hg');
  const lenEl = document.getElementById('len');
  const hgUnitEl = document.getElementById('hgUnit');
  const lenUnitEl = document.getElementById('lenUnit');
  const estWeightOut = document.getElementById('estWeight');

  const bcsEl = document.getElementById('bcs');
  const massEl = document.getElementById('mass');
  const asymEl = document.getElementById('asym');
  const fitEls = document.getElementsByName('fit');
  const medEl = document.getElementById('med');

  const bcsVal = document.getElementById('bcsVal');
  const massVal = document.getElementById('massVal');

  const baselineOut = document.getElementById('baselineOut');
  const adjPctOut = document.getElementById('adjPctOut');
  const wccOut = document.getElementById('wccOut');
  const bar = document.getElementById('bar');
  const toggleDetailsBtn = document.getElementById('toggleDetailsBtn');
  const detailsBreakdown = document.getElementById('detailsBreakdown');
  const bcsAdj = document.getElementById('bcsAdj');
  const massAdj = document.getElementById('massAdj');
  const asymAdj = document.getElementById('asymAdj');
  const fitAdj = document.getElementById('fitAdj');
  const medAdj = document.getElementById('medAdj');
  const warnMsg = document.getElementById('warnMsg');

  const tourBackdrop = document.getElementById('tourBackdrop');
  const tourCard = document.getElementById('tourCard');
  const tourStart = document.getElementById('tourStart');
  const tourClose = document.getElementById('tourClose');
  const tourPrev = document.getElementById('tourPrev');
  const tourNext = document.getElementById('tourNext');
  const tourStepTitle = document.getElementById('tourStepTitle');
  const tourStepBody = document.getElementById('tourStepBody');
  const tourDots = document.getElementById('tourDots');

  // ---------- Mode switching ----------
  let mode = 'weight'; // 'weight' or 'measure'
  function setMode(m) {
    mode = m;
    if (mode === 'weight') {
      panelWeight.classList.remove('hidden');
      panelMeasure.classList.add('hidden');
    } else {
      panelWeight.classList.add('hidden');
      panelMeasure.classList.remove('hidden');
    }
    calculate();
  }
  btnEstimateMode?.addEventListener('click', () => setMode('measure'));
  btnWeightMode?.addEventListener('click', () => setMode('weight'));
  toggleDetailsBtn.addEventListener('click', () => {
    const isHidden = detailsBreakdown.classList.toggle('hidden');
    toggleDetailsBtn.textContent = isHidden ? 'Show details' : 'Hide details';
  });

  // ---------- Popovers (non-intrusive info) ----------
  const infoButtons = document.querySelectorAll('.info-btn');
  infoButtons.forEach(btn => {
    const id = btn.dataset.pop;
    const pop = document.getElementById(id);
    let open = false;
    const closeAll = () => {
      document.querySelectorAll('.popover').forEach(p => p.classList.replace('shown-vis','hidden-vis'));
    };
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      open = !open;
      closeAll();
      pop.classList.toggle('hidden-vis', !open);
      pop.classList.toggle('shown-vis', open);
    });
    document.addEventListener('click', () => {
      open = false;
      pop.classList.replace('shown-vis','hidden-vis');
    });
    pop.addEventListener('click', e => e.stopPropagation());
  });

  // ---------- Tour (breadcrumbed mini-wizard) ----------
  const tourSteps = [
    {
      title: "1) Choose How You’ll Start",
      body: "If you have a recent scale or reliable tape weight, enter it here (switch units as needed). No weight handy? Click the estimator and we’ll compute weight from heartgirth (HG) and body length (L). We follow the standard livestock tape formula so results are field-usable.",
      target: '#panel-weight'
    },
    {
      title: "2) Understand & Set BCS (1–9)",
      body: "BCS rates <strong>fat cover</strong>, not muscle. Palpate and look at six zones: neck, withers, behind the shoulder, ribs, loin, and tailhead. Aim for <strong>around 5</strong> for a generally fit horse; each point away from 5 reduces the load limit in this tool. For a step‑by‑step visual guide, open the OSU Ohioline page (great for owners and techs). <br><a href='https://ohioline.osu.edu/factsheet/as-1024' target='_blank' class='text-accent-700 underline'>Learn BCS (OSU Ohioline)</a>",
      target: '#bcsGroup'
    },
    {
      title: "3) Understand & Set MASS (1–4)",
      body: "MASS detects <strong>muscle loss</strong> by region (neck, back, hindquarters). <strong>1 = none</strong>, <strong>4 = severe</strong>. Score both sides and note differences—this helps distinguish generalized loss from unilateral issues. Higher MASS (more atrophy) reduces the load limit more in this calculator. For an owner‑friendly picture guide, use this resource: <br><a href='https://www.spillers-feeds.com/muscle-wastage-scoring-guide' target='_blank' class='text-accent-700 underline'>MASS guide (visual)</a>",
      target: '#massGroup'
    },
    {
      title: "4) Run the Simple Fitness Test",
      body: "Record <strong>resting heart rate</strong>. Then <strong>walk 5 minutes</strong> and <strong>trot 3 minutes</strong>. Record HR <strong>immediately</strong>, <strong>at 3 minutes</strong>, and <strong>at 5 minutes</strong> post‑exercise. A well‑conditioned horse should be <strong>back to baseline by 5 minutes</strong>. Use this outcome to mark <strong>Overall Fitness</strong> as Good (0) or Poor (1). <br><a href='https://example.com/fitness-test' target='_blank' class='text-accent-700 underline'>Fitness test protocol (placeholder)</a>",
      target: '#fitnessGroup'
    },
    {
      title: "5) Check Gait Symmetry During the Test",
      body: "Watch the horse move on a level surface. If you see asymmetry only at <strong>trot</strong>, choose <strong>1</strong>. If it’s evident at <strong>both walk and trot</strong>, choose <strong>2</strong>. Symmetry issues suggest load should be reduced until resolved. <br><a href='https://example.com/symmetry-guide' target='_blank' class='text-accent-700 underline'>Symmetry how‑to (placeholder)</a>",
      target: '#asymGroup'
    },
    {
      title: "6) Review Your Output",
      body: "The <strong>baseline</strong> is <strong>20% of weight</strong>. We apply reductions for: being far from BCS 5, MASS > 1 (atrophy), asymmetry during the test, poor fitness (slow HR recovery), and medical concerns. The bar shows the percentage of baseline remaining. Your final number is a <strong>recommendation</strong>—pair it with professional judgment for your specific horse.",
      target: '#results-panel'
    }
  ];
  let tourIdx = 0;
  let currentHighlight = null;

  function renderDots() {
    tourDots.innerHTML = "";
    tourSteps.forEach((_, i) => {
      const dot = document.createElement('span');
      dot.className = "inline-block w-2 h-2 rounded-full " + (i===tourIdx ? "bg-accent-600" : "bg-base-300");
      tourDots.appendChild(dot);
    });
  }
  function positionTourCard(targetEl) {
    // Ensure card has measurable size
    const cardRect = tourCard.getBoundingClientRect();
    const tRect = targetEl.getBoundingClientRect();
    const margin = 12;
    const viewportW = window.innerWidth, viewportH = window.innerHeight;

    const spaceBelow = viewportH - tRect.bottom;
    let top = (spaceBelow > cardRect.height + margin) ? (tRect.bottom + margin) : (tRect.top - cardRect.height - margin);
    let left = tRect.left + (tRect.width / 2) - (cardRect.width / 2);

    left = Math.max(16, Math.min(left, viewportW - cardRect.width - 16));
    top  = Math.max(16, Math.min(top, viewportH - cardRect.height - 16));

    tourCard.style.left = left + 'px';
    tourCard.style.top  = top + 'px';
  }
  function showTourStep() {
    if (currentHighlight) {
        currentHighlight.classList.remove('tour-highlight');
    }
    const step = tourSteps[tourIdx];
    const targetEl = document.querySelector(step.target);

    if (targetEl) {
        currentHighlight = targetEl;
        targetEl.classList.add('tour-highlight');
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Position after scroll settles
        setTimeout(() => positionTourCard(targetEl), 220);
      }

    tourStepTitle.innerHTML = step.title;
    tourStepBody.innerHTML = step.body;
    tourPrev.disabled = (tourIdx === 0);
    tourPrev.style.opacity = (tourIdx === 0) ? 0.5 : 1;
    tourNext.textContent = (tourIdx === tourSteps.length - 1) ? "Finish" : "Next";
    renderDots();
  }
  function openTour() {
    tourIdx = 0;
    tourBackdrop.classList.remove('hidden');
    tourCard.classList.remove('hidden');
    showTourStep();
  }
  function closeTour() {
    if (currentHighlight) {
        currentHighlight.classList.remove('tour-highlight');
        currentHighlight = null;
    }
    tourBackdrop.classList.add('hidden');
    tourCard.classList.add('hidden');
  }
  tourStart.addEventListener('click', openTour);
  tourClose.addEventListener('click', closeTour);
  tourBackdrop.addEventListener('click', closeTour);
  tourPrev.addEventListener('click', () => { if (tourIdx > 0) { tourIdx--; showTourStep(); } });
  tourNext.addEventListener('click', () => {
    if (tourIdx < tourSteps.length - 1) { tourIdx++; showTourStep(); }
    else { closeTour(); }
  });
  window.addEventListener('resize', () => { if (!tourCard.classList.contains('hidden') && currentHighlight){ positionTourCard(currentHighlight); }});

  // ---------- Calculations ----------
  function currentFit() {
    for (const r of fitEls) if (r.checked) return Number(r.value);
    return 0;
  }

  function getWeightLb() {
    if (mode === 'weight') {
      const w = parseNum(weightEl);
      if (!isFinite(w)) return NaN;
      return (weightUnitEl.value === 'kg') ? w * 2.2046226218 : w;
    } else {
      // estimate from HG and L (inches; convert if cm)
      const hg = parseNum(hgEl);
      const len = parseNum(lenEl);
      if (!isFinite(hg) || !isFinite(len)) {
        estWeightOut.textContent = "—";
        return NaN;
      };
      const hgIn = (hgUnitEl.value === 'cm') ? (hg / 2.54) : hg;
      const lenIn = (lenUnitEl.value === 'cm') ? (len / 2.54) : len;
      const weight = (hgIn * hgIn * lenIn) / 330.0;
      if (isFinite(weight)) {
        estWeightOut.textContent = Math.round(weight).toLocaleString();
      } else {
        estWeightOut.textContent = "—";
      }
      return weight;
    }
  }

  function calculate() {
    // Live value displays
    bcsVal.textContent = bcsEl.value;
    massVal.textContent = massEl.value;

    const weightLb = getWeightLb();
    const baseline = isFinite(weightLb) ? 0.20 * weightLb : NaN;

    // Adjustments as FRACTIONS of baseline
    const bcs = Number(bcsEl.value);     // 1..9 (ideal 5)
    const mass = Number(massEl.value);   // 1..4 (ideal 1)
    const asym = Number(asymEl.value);   // 0,1,2
    const fit  = currentFit();           // 0 or 1
    const med  = medEl.checked ? 1 : 0;  // 0 or 1

    const redBCS  = Math.abs(5 - bcs) / 10;
    const redMASS = Math.abs(1 - mass) / 10;
    const redASYM = asym / 10;
    const redFIT  = 0.25 * fit;
    const redMED  = 0.25 * med;

    const totalReduction = redBCS + redMASS + redASYM + redFIT + redMED;

    let wcc = isFinite(baseline) ? baseline * (1 - totalReduction) : NaN;
    let floored = false;
    if (isFinite(wcc) && wcc < 0) { wcc = 0; floored = true; }

    baselineOut.textContent = fmtLb(baseline);
    adjPctOut.textContent   = isFinite(totalReduction) ? "−" + fmtPct(totalReduction) : "—";
    wccOut.textContent      = isFinite(wcc) ? fmtLb(wcc) : "—";

    bcsAdj.textContent  = isFinite(redBCS)  ? "−" + fmtPct(redBCS)  : "—";
    massAdj.textContent = isFinite(redMASS) ? "−" + fmtPct(redMASS) : "—";
    asymAdj.textContent = isFinite(redASYM) ? "−" + fmtPct(redASYM) : "—";
    fitAdj.textContent  = isFinite(redFIT)  ? "−" + fmtPct(redFIT)  : "—";
    medAdj.textContent  = isFinite(redMED)  ? "−" + fmtPct(redMED)  : "—";

    const pct = (isFinite(baseline) && baseline > 0 && isFinite(wcc)) ? clamp((wcc / baseline) * 100, 0, 100) : 0;
    bar.style.width = pct + "%";

    warnMsg.classList.toggle('hidden', !floored);
  }

  [
    weightEl, weightUnitEl,
    hgEl, lenEl, hgUnitEl, lenUnitEl,
    bcsEl, massEl, asymEl, medEl
  ].forEach(el => el.addEventListener('input', calculate));
  fitEls.forEach(el => el.addEventListener('change', calculate));

  setMode('weight');
  calculate();
  </script>

  <!-- Footer -->
  <footer class="fixed left-0 right-0 bottom-0 pointer-events-none">
    <div class="max-w-3xl mx-auto px-4 pb-4 flex justify-end">
      <div class="pointer-events-auto px-3 py-1.5 rounded-lg bg-white/70 backdrop-blur text-[11px] text-base-700 ring-1 ring-base-300">
        For field guidance only. Always consider the individual horse and professional judgment.
      </div>
    </div>
  </footer>
</body>
</html>



